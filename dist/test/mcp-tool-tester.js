"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MCPToolTester = void 0;
/**
 * MCP 工具测试器 - 直接测试通过 WebSocket 的 MCP 工具
 */
class MCPToolTester {
    constructor() {
        this.ws = null;
        this.messageId = 0;
        this.responseHandlers = new Map();
    }
    async connect(port) {
        return new Promise((resolve) => {
            try {
                this.ws = new WebSocket(`ws://localhost:${port}`);
                this.ws.onopen = () => {
                    console.log('WebSocket 连接成功');
                    resolve(true);
                };
                this.ws.onerror = (error) => {
                    console.error('WebSocket 连接错误:', error);
                    resolve(false);
                };
                this.ws.onmessage = (event) => {
                    try {
                        const response = JSON.parse(event.data);
                        if (response.id && this.responseHandlers.has(response.id)) {
                            const handler = this.responseHandlers.get(response.id);
                            this.responseHandlers.delete(response.id);
                            handler === null || handler === void 0 ? void 0 : handler(response);
                        }
                    }
                    catch (error) {
                        console.error('处理响应时出错:', error);
                    }
                };
            }
            catch (error) {
                console.error('创建 WebSocket 时出错:', error);
                resolve(false);
            }
        });
    }
    async callTool(tool, args = {}) {
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
            throw new Error('WebSocket 未连接');
        }
        return new Promise((resolve, reject) => {
            const id = ++this.messageId;
            const request = {
                jsonrpc: '2.0',
                id,
                method: 'tools/call',
                params: {
                    name: tool,
                    arguments: args
                }
            };
            const timeout = setTimeout(() => {
                this.responseHandlers.delete(id);
                reject(new Error('请求超时'));
            }, 10000);
            this.responseHandlers.set(id, (response) => {
                clearTimeout(timeout);
                if (response.error) {
                    reject(new Error(response.error.message));
                }
                else {
                    resolve(response.result);
                }
            });
            this.ws.send(JSON.stringify(request));
        });
    }
    async listTools() {
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
            throw new Error('WebSocket 未连接');
        }
        return new Promise((resolve, reject) => {
            const id = ++this.messageId;
            const request = {
                jsonrpc: '2.0',
                id,
                method: 'tools/list'
            };
            const timeout = setTimeout(() => {
                this.responseHandlers.delete(id);
                reject(new Error('请求超时'));
            }, 10000);
            this.responseHandlers.set(id, (response) => {
                clearTimeout(timeout);
                if (response.error) {
                    reject(new Error(response.error.message));
                }
                else {
                    resolve(response.result);
                }
            });
            this.ws.send(JSON.stringify(request));
        });
    }
    async testMCPTools() {
        var _a, _b;
        console.log('\n=== 测试 MCP 工具（通过 WebSocket）===');
        try {
            // 0. 获取工具列表
            console.log('\n0. 获取工具列表...');
            const toolsList = await this.listTools();
            console.log(`找到 ${((_a = toolsList.tools) === null || _a === void 0 ? void 0 : _a.length) || 0} 个工具:`);
            if (toolsList.tools) {
                for (const tool of toolsList.tools.slice(0, 10)) { // 只显示前10个
                    console.log(`  - ${tool.name}: ${tool.description}`);
                }
                if (toolsList.tools.length > 10) {
                    console.log(`  ... 还有 ${toolsList.tools.length - 10} 个工具`);
                }
            }
            // 1. 测试场景工具
            console.log('\n1. 测试当前场景信息...');
            const sceneInfo = await this.callTool('scene_get_current_scene');
            console.log('场景信息:', JSON.stringify(sceneInfo).substring(0, 100) + '...');
            // 2. 测试场景列表
            console.log('\n2. 测试场景列表...');
            const sceneList = await this.callTool('scene_get_scene_list');
            console.log('场景列表:', JSON.stringify(sceneList).substring(0, 100) + '...');
            // 3. 测试节点创建
            console.log('\n3. 测试创建节点...');
            const createResult = await this.callTool('node_create_node', {
                name: 'MCPTestNode_' + Date.now(),
                nodeType: 'cc.Node',
                position: { x: 0, y: 0, z: 0 }
            });
            console.log('创建节点结果:', createResult);
            // 解析创建节点的结果
            let nodeUuid = null;
            if (createResult.content && createResult.content[0] && createResult.content[0].text) {
                try {
                    const resultData = JSON.parse(createResult.content[0].text);
                    if (resultData.success && resultData.data && resultData.data.uuid) {
                        nodeUuid = resultData.data.uuid;
                        console.log('成功获取节点UUID:', nodeUuid);
                    }
                }
                catch (e) {
                }
            }
            if (nodeUuid) {
                // 4. 测试查询节点
                console.log('\n4. 测试查询节点...');
                const queryResult = await this.callTool('node_get_node_info', {
                    uuid: nodeUuid
                });
                console.log('节点信息:', JSON.stringify(queryResult).substring(0, 100) + '...');
                // 5. 测试删除节点
                console.log('\n5. 测试删除节点...');
                const removeResult = await this.callTool('node_delete_node', {
                    uuid: nodeUuid
                });
                console.log('删除结果:', removeResult);
            }
            else {
                console.log('无法从创建结果获取节点UUID，尝试通过名称查找...');
                // 备用方案：通过名称查找刚创建的节点
                const findResult = await this.callTool('node_find_node_by_name', {
                    name: 'MCPTestNode_' + Date.now()
                });
                if (findResult.content && findResult.content[0] && findResult.content[0].text) {
                    try {
                        const findData = JSON.parse(findResult.content[0].text);
                        if (findData.success && findData.data && findData.data.uuid) {
                            nodeUuid = findData.data.uuid;
                            console.log('通过名称查找成功获取UUID:', nodeUuid);
                        }
                    }
                    catch (e) {
                    }
                }
                if (!nodeUuid) {
                    console.log('所有方式都无法获取节点UUID，跳过后续节点操作测试');
                }
            }
            // 6. 测试项目工具
            console.log('\n6. 测试项目信息...');
            const projectInfo = await this.callTool('project_get_project_info');
            console.log('项目信息:', JSON.stringify(projectInfo).substring(0, 100) + '...');
            // 7. 测试预制体工具
            console.log('\n7. 测试预制体列表...');
            const prefabResult = await this.callTool('prefab_get_prefab_list', {
                folder: 'db://assets'
            });
            console.log('找到预制体:', ((_b = prefabResult.data) === null || _b === void 0 ? void 0 : _b.length) || 0);
            // 8. 测试组件工具
            console.log('\n8. 测试可用组件...');
            const componentsResult = await this.callTool('component_get_available_components');
            console.log('可用组件:', JSON.stringify(componentsResult).substring(0, 100) + '...');
            // 9. 测试调试工具
            console.log('\n9. 测试编辑器信息...');
            const editorInfo = await this.callTool('debug_get_editor_info');
            console.log('编辑器信息:', JSON.stringify(editorInfo).substring(0, 100) + '...');
        }
        catch (error) {
            console.error('MCP 工具测试失败:', error);
        }
    }
    disconnect() {
        if (this.ws) {
            this.ws.close();
            this.ws = null;
        }
        this.responseHandlers.clear();
    }
}
exports.MCPToolTester = MCPToolTester;
// 导出到全局方便测试
global.MCPToolTester = MCPToolTester;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWNwLXRvb2wtdGVzdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL3Rlc3QvbWNwLXRvb2wtdGVzdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBOztHQUVHO0FBQ0gsTUFBYSxhQUFhO0lBQTFCO1FBQ1ksT0FBRSxHQUFxQixJQUFJLENBQUM7UUFDNUIsY0FBUyxHQUFHLENBQUMsQ0FBQztRQUNkLHFCQUFnQixHQUFHLElBQUksR0FBRyxFQUFtQyxDQUFDO0lBK04xRSxDQUFDO0lBN05HLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBWTtRQUN0QixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDM0IsSUFBSTtnQkFDQSxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksU0FBUyxDQUFDLGtCQUFrQixJQUFJLEVBQUUsQ0FBQyxDQUFDO2dCQUVsRCxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7b0JBQ2xCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztvQkFDOUIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNsQixDQUFDLENBQUM7Z0JBRUYsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxLQUFLLEVBQUUsRUFBRTtvQkFDeEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxLQUFLLENBQUMsQ0FBQztvQkFDeEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuQixDQUFDLENBQUM7Z0JBRUYsSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxLQUFLLEVBQUUsRUFBRTtvQkFDMUIsSUFBSTt3QkFDQSxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDeEMsSUFBSSxRQUFRLENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQyxn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VUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1lBQ2hFLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQztTQUUvRTtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ1osT0FBTyxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdkM7SUFDTCxDQUFDO0lBRUQsVUFBVTtRQUNOLElBQUksSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNULElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUM7U0FDbEI7UUFDRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDbEMsQ0FBQztDQUNKO0FBbE9ELHNDQWtPQztBQUVELFlBQVk7QUFDWCxNQUFjLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImRlY2xhcmUgY29uc3QgRWRpdG9yOiBhbnk7XG5cbi8qKlxuICogTUNQIOW3peWFt+a1i+ivleWZqCAtIOebtOaOpea1i+ivlemAmui/hyBXZWJTb2NrZXQg55qEIE1DUCDlt6XlhbdcbiAqL1xuZXhwb3J0IGNsYXNzIE1DUFRvb2xUZXN0ZXIge1xuICAgIHByaXZhdGUgd3M6IFdlYlNvY2tldCB8IG51bGwgPSBudWxsO1xuICAgIHByaXZhdGUgbWVzc2FnZUlkID0gMDtcbiAgICBwcml2YXRlIHJlc3BvbnNlSGFuZGxlcnMgPSBuZXcgTWFwPG51bWJlciwgKHJlc3BvbnNlOiBhbnkpID0+IHZvaWQ+KCk7XG5cbiAgICBhc3luYyBjb25uZWN0KHBvcnQ6IG51bWJlcik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy53cyA9IG5ldyBXZWJTb2NrZXQoYHdzOi8vbG9jYWxob3N0OiR7cG9ydH1gKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0aGlzLndzLm9ub3BlbiA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1dlYlNvY2tldCDov57mjqXmiJDlip8nKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRoaXMud3Mub25lcnJvciA9IChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdXZWJTb2NrZXQg6L+e5o6l6ZSZ6K+vOicsIGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0aGlzLndzLm9ubWVzc2FnZSA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBKU09OLnBhcnNlKGV2ZW50LmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmlkICYmIHRoaXMucmVzcG9uc2VIYW5kbGVycy5oYXMocmVzcG9uc2UuaWQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFuZGxlciA9IHRoaXMucmVzcG9uc2VIYW5kbGVycy5nZXQocmVzcG9uc2UuaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzcG9uc2VIYW5kbGVycy5kZWxldGUocmVzcG9uc2UuaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXI/LihyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCflpITnkIblk43lupTml7blh7rplJk6JywgZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcign5Yib5bu6IFdlYlNvY2tldCDml7blh7rplJk6JywgZXJyb3IpO1xuICAgICAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBjYWxsVG9vbCh0b29sOiBzdHJpbmcsIGFyZ3M6IGFueSA9IHt9KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgaWYgKCF0aGlzLndzIHx8IHRoaXMud3MucmVhZHlTdGF0ZSAhPT0gV2ViU29ja2V0Lk9QRU4pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignV2ViU29ja2V0IOacqui/nuaOpScpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gKyt0aGlzLm1lc3NhZ2VJZDtcbiAgICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgbWV0aG9kOiAndG9vbHMvY2FsbCcsXG4gICAgICAgICAgICAgICAgcGFyYW1zOiB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHRvb2wsXG4gICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50czogYXJnc1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGNvbnN0IHRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlc3BvbnNlSGFuZGxlcnMuZGVsZXRlKGlkKTtcbiAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCfor7fmsYLotoXml7YnKSk7XG4gICAgICAgICAgICB9LCAxMDAwMCk7XG5cbiAgICAgICAgICAgIHRoaXMucmVzcG9uc2VIYW5kbGVycy5zZXQoaWQsIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihyZXNwb25zZS5lcnJvci5tZXNzYWdlKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZS5yZXN1bHQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLndzIS5zZW5kKEpTT04uc3RyaW5naWZ5KHJlcXVlc3QpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgbGlzdFRvb2xzKCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGlmICghdGhpcy53cyB8fCB0aGlzLndzLnJlYWR5U3RhdGUgIT09IFdlYlNvY2tldC5PUEVOKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dlYlNvY2tldCDmnKrov57mjqUnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpZCA9ICsrdGhpcy5tZXNzYWdlSWQ7XG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgICAgIG1ldGhvZDogJ3Rvb2xzL2xpc3QnXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXNwb25zZUhhbmRsZXJzLmRlbGV0ZShpZCk7XG4gICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcign6K+35rGC6LaF5pe2JykpO1xuICAgICAgICAgICAgfSwgMTAwMDApO1xuXG4gICAgICAgICAgICB0aGlzLnJlc3BvbnNlSGFuZGxlcnMuc2V0KGlkLCAocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IocmVzcG9uc2UuZXJyb3IubWVzc2FnZSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UucmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy53cyEuc2VuZChKU09OLnN0cmluZ2lmeShyZXF1ZXN0KSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHRlc3RNQ1BUb29scygpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ1xcbj09PSDmtYvor5UgTUNQIOW3peWFt++8iOmAmui/hyBXZWJTb2NrZXTvvIk9PT0nKTtcbiAgICAgICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyAwLiDojrflj5blt6XlhbfliJfooahcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdcXG4wLiDojrflj5blt6XlhbfliJfooaguLi4nKTtcbiAgICAgICAgICAgIGNvbnN0IHRvb2xzTGlzdCA9IGF3YWl0IHRoaXMubGlzdFRvb2xzKCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhg5om+5YiwICR7dG9vbHNMaXN0LnRvb2xzPy5sZW5ndGggfHwgMH0g5Liq5bel5YW3OmApO1xuICAgICAgICAgICAgaWYgKHRvb2xzTGlzdC50b29scykge1xuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdG9vbCBvZiB0b29sc0xpc3QudG9vbHMuc2xpY2UoMCwgMTApKSB7IC8vIOWPquaYvuekuuWJjTEw5LiqXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAgIC0gJHt0b29sLm5hbWV9OiAke3Rvb2wuZGVzY3JpcHRpb259YCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0b29sc0xpc3QudG9vbHMubGVuZ3RoID4gMTApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCAgLi4uIOi/mOaciSAke3Rvb2xzTGlzdC50b29scy5sZW5ndGggLSAxMH0g5Liq5bel5YW3YCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyAxLiDmtYvor5XlnLrmma/lt6XlhbdcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdcXG4xLiDmtYvor5XlvZPliY3lnLrmma/kv6Hmga8uLi4nKTtcbiAgICAgICAgICAgIGNvbnN0IHNjZW5lSW5mbyA9IGF3YWl0IHRoaXMuY2FsbFRvb2woJ3NjZW5lX2dldF9jdXJyZW50X3NjZW5lJyk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygn5Zy65pmv5L+h5oGvOicsIEpTT04uc3RyaW5naWZ5KHNjZW5lSW5mbykuc3Vic3RyaW5nKDAsIDEwMCkgKyAnLi4uJyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIDIuIOa1i+ivleWcuuaZr+WIl+ihqFxuICAgICAgICAgICAgY29uc29sZS5sb2coJ1xcbjIuIOa1i+ivleWcuuaZr+WIl+ihqC4uLicpO1xuICAgICAgICAgICAgY29uc3Qgc2NlbmVMaXN0ID0gYXdhaXQgdGhpcy5jYWxsVG9vbCgnc2NlbmVfZ2V0X3NjZW5lX2xpc3QnKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCflnLrmma/liJfooag6JywgSlNPTi5zdHJpbmdpZnkoc2NlbmVMaXN0KS5zdWJzdHJpbmcoMCwgMTAwKSArICcuLi4nKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gMy4g5rWL6K+V6IqC54K55Yib5bu6XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnXFxuMy4g5rWL6K+V5Yib5bu66IqC54K5Li4uJyk7XG4gICAgICAgICAgICBjb25zdCBjcmVhdGVSZXN1bHQgPSBhd2FpdCB0aGlzLmNhbGxUb29sKCdub2RlX2NyZWF0ZV9ub2RlJywge1xuICAgICAgICAgICAgICAgIG5hbWU6ICdNQ1BUZXN0Tm9kZV8nICsgRGF0ZS5ub3coKSxcbiAgICAgICAgICAgICAgICBub2RlVHlwZTogJ2NjLk5vZGUnLFxuICAgICAgICAgICAgICAgIHBvc2l0aW9uOiB7IHg6IDAsIHk6IDAsIHo6IDAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygn5Yib5bu66IqC54K557uT5p6cOicsIGNyZWF0ZVJlc3VsdCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIOino+aekOWIm+W7uuiKgueCueeahOe7k+aenFxuICAgICAgICAgICAgbGV0IG5vZGVVdWlkOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcbiAgICAgICAgICAgIGlmIChjcmVhdGVSZXN1bHQuY29udGVudCAmJiBjcmVhdGVSZXN1bHQuY29udGVudFswXSAmJiBjcmVhdGVSZXN1bHQuY29udGVudFswXS50ZXh0KSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0RGF0YSA9IEpTT04ucGFyc2UoY3JlYXRlUmVzdWx0LmNvbnRlbnRbMF0udGV4dCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHREYXRhLnN1Y2Nlc3MgJiYgcmVzdWx0RGF0YS5kYXRhICYmIHJlc3VsdERhdGEuZGF0YS51dWlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlVXVpZCA9IHJlc3VsdERhdGEuZGF0YS51dWlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ+aIkOWKn+iOt+WPluiKgueCuVVVSUQ6Jywgbm9kZVV1aWQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKG5vZGVVdWlkKSB7XG4gICAgICAgICAgICAgICAgLy8gNC4g5rWL6K+V5p+l6K+i6IqC54K5XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1xcbjQuIOa1i+ivleafpeivouiKgueCuS4uLicpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHF1ZXJ5UmVzdWx0ID0gYXdhaXQgdGhpcy5jYWxsVG9vbCgnbm9kZV9nZXRfbm9kZV9pbmZvJywge1xuICAgICAgICAgICAgICAgICAgICB1dWlkOiBub2RlVXVpZFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCfoioLngrnkv6Hmga86JywgSlNPTi5zdHJpbmdpZnkocXVlcnlSZXN1bHQpLnN1YnN0cmluZygwLCAxMDApICsgJy4uLicpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIDUuIOa1i+ivleWIoOmZpOiKgueCuVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdcXG41LiDmtYvor5XliKDpmaToioLngrkuLi4nKTtcbiAgICAgICAgICAgICAgICBjb25zdCByZW1vdmVSZXN1bHQgPSBhd2FpdCB0aGlzLmNhbGxUb29sKCdub2RlX2RlbGV0ZV9ub2RlJywge1xuICAgICAgICAgICAgICAgICAgICB1dWlkOiBub2RlVXVpZFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCfliKDpmaTnu5Pmnpw6JywgcmVtb3ZlUmVzdWx0KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ+aXoOazleS7juWIm+W7uue7k+aenOiOt+WPluiKgueCuVVVSUTvvIzlsJ3or5XpgJrov4flkI3np7Dmn6Xmib4uLi4nKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyDlpIfnlKjmlrnmoYjvvJrpgJrov4flkI3np7Dmn6Xmib7liJrliJvlu7rnmoToioLngrlcbiAgICAgICAgICAgICAgICBjb25zdCBmaW5kUmVzdWx0ID0gYXdhaXQgdGhpcy5jYWxsVG9vbCgnbm9kZV9maW5kX25vZGVfYnlfbmFtZScsIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ01DUFRlc3ROb2RlXycgKyBEYXRlLm5vdygpXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGZpbmRSZXN1bHQuY29udGVudCAmJiBmaW5kUmVzdWx0LmNvbnRlbnRbMF0gJiYgZmluZFJlc3VsdC5jb250ZW50WzBdLnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmREYXRhID0gSlNPTi5wYXJzZShmaW5kUmVzdWx0LmNvbnRlbnRbMF0udGV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmluZERhdGEuc3VjY2VzcyAmJiBmaW5kRGF0YS5kYXRhICYmIGZpbmREYXRhLmRhdGEudXVpZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVVdWlkID0gZmluZERhdGEuZGF0YS51dWlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCfpgJrov4flkI3np7Dmn6Xmib7miJDlip/ojrflj5ZVVUlEOicsIG5vZGVVdWlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICghbm9kZVV1aWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ+aJgOacieaWueW8j+mDveaXoOazleiOt+WPluiKgueCuVVVSUTvvIzot7Pov4flkI7nu63oioLngrnmk43kvZzmtYvor5UnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIDYuIOa1i+ivlemhueebruW3peWFt1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1xcbjYuIOa1i+ivlemhueebruS/oeaBry4uLicpO1xuICAgICAgICAgICAgY29uc3QgcHJvamVjdEluZm8gPSBhd2FpdCB0aGlzLmNhbGxUb29sKCdwcm9qZWN0X2dldF9wcm9qZWN0X2luZm8nKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCfpobnnm67kv6Hmga86JywgSlNPTi5zdHJpbmdpZnkocHJvamVjdEluZm8pLnN1YnN0cmluZygwLCAxMDApICsgJy4uLicpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyA3LiDmtYvor5XpooTliLbkvZPlt6XlhbdcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdcXG43LiDmtYvor5XpooTliLbkvZPliJfooaguLi4nKTtcbiAgICAgICAgICAgIGNvbnN0IHByZWZhYlJlc3VsdCA9IGF3YWl0IHRoaXMuY2FsbFRvb2woJ3ByZWZhYl9nZXRfcHJlZmFiX2xpc3QnLCB7XG4gICAgICAgICAgICAgICAgZm9sZGVyOiAnZGI6Ly9hc3NldHMnXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCfmib7liLDpooTliLbkvZM6JywgcHJlZmFiUmVzdWx0LmRhdGE/Lmxlbmd0aCB8fCAwKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gOC4g5rWL6K+V57uE5Lu25bel5YW3XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnXFxuOC4g5rWL6K+V5Y+v55So57uE5Lu2Li4uJyk7XG4gICAgICAgICAgICBjb25zdCBjb21wb25lbnRzUmVzdWx0ID0gYXdhaXQgdGhpcy5jYWxsVG9vbCgnY29tcG9uZW50X2dldF9hdmFpbGFibGVfY29tcG9uZW50cycpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ+WPr+eUqOe7hOS7tjonLCBKU09OLnN0cmluZ2lmeShjb21wb25lbnRzUmVzdWx0KS5zdWJzdHJpbmcoMCwgMTAwKSArICcuLi4nKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gOS4g5rWL6K+V6LCD6K+V5bel5YW3XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnXFxuOS4g5rWL6K+V57yW6L6R5Zmo5L+h5oGvLi4uJyk7XG4gICAgICAgICAgICBjb25zdCBlZGl0b3JJbmZvID0gYXdhaXQgdGhpcy5jYWxsVG9vbCgnZGVidWdfZ2V0X2VkaXRvcl9pbmZvJyk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygn57yW6L6R5Zmo5L+h5oGvOicsIEpTT04uc3RyaW5naWZ5KGVkaXRvckluZm8pLnN1YnN0cmluZygwLCAxMDApICsgJy4uLicpO1xuICAgICAgICAgICAgXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdNQ1Ag5bel5YW35rWL6K+V5aSx6LSlOicsIGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGRpc2Nvbm5lY3QoKSB7XG4gICAgICAgIGlmICh0aGlzLndzKSB7XG4gICAgICAgICAgICB0aGlzLndzLmNsb3NlKCk7XG4gICAgICAgICAgICB0aGlzLndzID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlc3BvbnNlSGFuZGxlcnMuY2xlYXIoKTtcbiAgICB9XG59XG5cbi8vIOWvvOWHuuWIsOWFqOWxgOaWueS+v+a1i+ivlVxuKGdsb2JhbCBhcyBhbnkpLk1DUFRvb2xUZXN0ZXIgPSBNQ1BUb29sVGVzdGVyOyJdfQ==